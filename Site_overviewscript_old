SELECT DISTINCT * FROM
(WITH latestFrame AS      
(
    SELECT DISTINCT 
    frame.id AS FrameID,
    SPLIT(frame.id, '#')[SAFE_OFFSET(0)] AS SiteID,
    DATETIME_TRUNC(DATETIME(aggregate.arrival.timestamp,aggregate.timeZone),SECOND) AS ArrivalTime,
    DATETIME_TRUNC(DATETIME(aggregate.departure.timestamp,aggregate.timeZone),SECOND) AS DepartureTime,
    CASE WHEN aggregate.arrival.timestamp IS NOT NULL AND aggregate.departure.timestamp IS NOT NULL THEN 1 ELSE 0 END AS Stay,
    CASE WHEN aggregate.arrival.timestamp IS NOT NULL THEN 1 ELSE 0 END AS ArrivalCount,
    CASE WHEN aggregate.departure.timestamp IS NOT NULL THEN 1 ELSE 0 END AS DepartureCount,
    CASE 
        WHEN aggregate.arrival.timestamp IS NOT NULL THEN DATE(aggregate.arrival.timestamp,aggregate.timeZone)
        ELSE DATE(aggregate.departure.timestamp,aggregate.timeZone) 
    END AS DateValue,
    CASE WHEN aggregate.arrival.timestamp IS NOT NULL AND aggregate.departure.timestamp IS NOT NULL 
        THEN ROUND((DATETIME_DIFF(DATETIME(aggregate.departure.timestamp,aggregate.timeZone),DATETIME(aggregate.arrival.timestamp,aggregate.timeZone),SECOND))/60,1)
    ELSE 0 END AS StayDurationMinutes,
    ROW_NUMBER() OVER (PARTITION BY frame.id ORDER BY fact.timestamp DESC) AS rn
    FROM `sc-neptune-production.lpr_frames.lpr_frames_scm`
    WHERE frame.id NOT IN
        (SELECT DISTINCT frame.id FROM  `sc-neptune-production.lpr_frames.lpr_frames_scm` WHERE LOWER(fact.subtype)='deletion')
    AND fact.timestamp IS NOT NULL)
    SELECT DISTINCT 
    FrameID,
    SiteID,
    'N/A' AS CaseID,
    'N/A' AS BreachID,
    'N/A' AS State,
    'N/A' AS SubState,
    Stay,
    ArrivalCount,
    DepartureCount,
    DateValue,
    StayDurationMinutes,
    CASE 
        WHEN ArrivalTime IS NOT NULL THEN  EXTRACT(HOUR FROM ArrivalTime)
        ELSE EXTRACT(HOUR FROM DepartureTime) 
    END AS Hour,
    FORMAT_DATE('%A',DateValue) AS Day
    FROM latestFrame
    WHERE 
    datevalue BETWEEN PARSE_DATE('%Y%m%d',@DS_START_DATE) AND PARSE_DATE('%Y%m%d',@DS_END_DATE) AND
    rn=1 AND StayDurationMinutes<=10000
UNION ALL
    (
        WITH earliest_rev AS
(
    SELECT 
    DISTINCT *,
    DATE(CaseTime) AS CaseDate,
    ROW_NUMBER() OVER (PARTITION BY CaseID,BreachID,state,UpdatedSubState ORDER BY Revision ASC) AS rn
    FROM
    (
SELECT 
DISTINCT
  cc.id AS CaseID,
  CAST(rev AS INT64) AS Revision,
  State,
  CASE WHEN canceled.reason IS NULL THEN 'N/A' ELSE canceled.reason END AS CancelledReason,
  CASE
    WHEN Substate IS NULL THEN Sub_States
    ELSE SubState
  END AS UpdatedSubState,
  DATETIME_TRUNC(DATETIME(caseRef.timestamp,timezone),SECOND) AS CaseTime,
  SPLIT(g.groupref, '#')[SAFE_OFFSET(1)] AS SiteID,
  b.ticketid AS BreachID
FROM
  `sc-neptune-production.contravention_parking_cases_v2.contravention_parking_cases_v2_scm` cc
  LEFT JOIN UNNEST(breaches) AS b
  LEFT JOIN UNNEST(subStates) as Sub_States
  LEFT JOIN UNNEST(cc.groups) AS g
  WHERE 
  LOWER(g.type)='site'
  AND cc.id NOT IN(
    SELECT DISTINCT cc.id
    FROM
  `sc-neptune-production.contravention_parking_cases_v2.contravention_parking_cases_v2_scm` cc
   LEFT JOIN UNNEST(subStates) as Sub_States
   WHERE LOWER(SubState) IN ('sysops','unprocessed','tech-cancel') OR 
         LOWER(Sub_States) IN ('sysops','unprocessed','tech-cancel')
    OR LOWER(canceled.reason) IN ('system admin task','removed for system testing or maintenance','cancelled for reload','case needs to be reloaded')
         )
  )
)
SELECT DISTINCT 
'N/A' , 
SiteID,
CaseID,
BreachID,
State,
UpdatedSubState AS SubState,
0 AS Stay,
0 AS ArrivalCount,
0 As DepartureCount,
CaseDate,
0 AS StayDuration,
EXTRACT(HOUR FROM CaseTime) AS Hour,
FORMAT_DATE('%A',CaseDate) AS Day
FROM earliest_rev
WHERE rn=1
AND  CaseDate BETWEEN PARSE_DATE('%Y%m%d',@DS_START_DATE) AND PARSE_DATE('%Y%m%d',@DS_END_DATE)

 ))
--INNER JOIN to retrieve site name
INNER JOIN 
(
WITH latest_groupID AS (
SELECT DISTINCT name, groupId,
ROW_NUMBER() OVER (PARTITION BY groupId ORDER BY timestamp DESC) AS grn
FROM `sc-neptune-production.group_actions.group_actions_scm` )
 SELECT DISTINCT name AS Site,groupID  from latest_groupID
WHERE grn=1
 )
ON 
SiteID=groupID

  